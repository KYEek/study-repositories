package jdbc.day02;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.Scanner;

/*
 == λ¨Όμ € jdbc_day02.sql νμΌμ„ μ—΄μ–΄μ„ tbl_class ν…μ΄λΈ” λ° tbl_student ν…μ΄λΈ”μ„ μƒμ„±ν•λ‹¤. 
   == κ·Έλ¦¬κ³  μ•„λμ™€ κ°™μ΄ μ¤λΌν΄μ—μ„ ν”„λ΅μ‹μ €λ¥Ό μƒμ„±ν•΄μ•Ό ν•λ‹¤. ==
   
   >>>> Stored Procedure λ€? <<<<<
      Query λ¬Έμ„ ν•λ‚μ νμΌν•νƒλ΅ λ§λ“¤κ±°λ‚ λ°μ΄ν„°λ² μ΄μ¤μ— μ €μ¥ν•΄ λ†“κ³  ν•¨μμ²λΌ νΈμ¶ν•΄μ„ μ‚¬μ©ν•λ” κ²ƒμ„.
      Stored Procedure λ¥Ό μ‚¬μ©ν•λ©΄ μ—°μ†λλ” query λ¬Έμ— λ€ν•΄μ„ λ§¤μ° λΉ λ¥Έ μ„±λ¥μ„ λ³΄μ΄λ©°, 
      μ½”λ“μ λ…λ¦½μ„±κ³Ό ν•¨κ» λ³΄μ•μ μΈ μ¥μ λ„ κ°€μ§€κ² λλ‹¤. 
 
 create or replace procedure pcd_student_select_one 
    (p_stno         in  tbl_student.stno%type
    ,o_stno         out tbl_student.stno%type
    ,o_name         out tbl_student.name%type
    ,o_tel          out tbl_student.tel%type
    ,o_addr         out tbl_student.addr%type
    ,o_registerdate out tbl_student.registerdate%type
    ,o_classno      out tbl_class.classno%type
    ,o_classname    out tbl_class.classname%type
    ,o_teachername  out tbl_class.teachername%type)
    
    is
        v_cnt   number(1);
        
    begin
        select count(*) into v_cnt
        from tbl_student
        where stno = p_stno;
        
        if v_cnt = 0 then
            o_stno := 0;
            o_name := null;
            o_tel := null;
            o_addr := null;
            o_registerdate := null;
            o_classno := null;
            o_classname := null;
            o_teachername := null;
        else
            select stno, name, tel, addr, to_char(registerdate, 'yyyy-mm-dd') as registerday, fk_classno, classname, teachername
            into o_stno, o_name, o_tel, o_addr, o_registerdate, o_classno, o_classname, o_teachername
            from tbl_student S join tbl_class C
            on s.fk_classno = c.classno
            where stno = p_stno;
        end if;
        
    end pcd_student_select_one; 
 
 */

public class Procedure_select_one_CallableStatement_02 {

	public static void main(String[] args) {
		
		Connection conn = null;
		
		CallableStatement cstmt = null;
		// CallableStatement cstmt μ€ Connection conn(μ—°κ²°ν• DB μ„λ²„)μ— μ΅΄μ¬ν•λ” Procedure λ¥Ό νΈμ¶ν•΄μ£Όλ” κ°μ²΄(μ°νΈλ°°λ‹¬λ¶€)μ΄λ‹¤.
		
		try {
				Class.forName("oracle.jdbc.driver.OracleDriver");
				

				conn = DriverManager.getConnection("jdbc:oracle:thin:@127.0.0.1:1521:xe", "JDBC_USER", "gclass");
				
				
				// >>> 3. Connection conn κ°μ²΄λ¥Ό μ‚¬μ©ν•μ—¬ prepareCall() λ©”μ†λ“λ¥Ό νΈμ¶ν•¨μΌλ΅μ¨
		        //        CallableStatement cstmt κ°μ²΄λ¥Ό μƒμ„±ν•λ‹¤.
		        //        μ¦‰, μ°νΈλ°°λ‹¬λ¶€(νƒλ°°κΈ°μ‚¬) κ°μ²΄ λ§λ“¤κΈ°
				cstmt = conn.prepareCall("{call pcd_student_select_one(to_number(?),?,?,?,?,?,?,?,?)}");
				/*
					 μ¤λΌν΄ μ„λ²„μ— μƒμ„±ν• ν”„λ΅μ‹μ € pcd_student_select_one μ 
	            	 λ§¤κ°λ³€μ κ°―μκ°€ 9κ° μ΄λ―€λ΅ ? λ¥Ό 9κ° μ¤€λ‹¤.
	            	 
	            	 λ‹¤μμΌλ΅ μ¤λΌν΄μ ν”„λ΅μ‹μ €λ¥Ό μν–‰( executeUpdate() λλ” execute() ) ν•κΈ°μ— μ•μ„μ„  
					λ°λ“μ‹ ν•΄μ•Όν•  μΌμ€ IN mode λ΅ λμ–΄μ§„ νλΌλ―Έν„°μ— κ°’μ„ λ„£μ–΄μ£Όκ³ ,
					OUT mode λ΅ μ„¤μ •λ κ³³μ— κ·Έ κ²°κ³Όκ°’μ„ λ°›μ•„μ¤λ„λ΅ μ•„λμ™€ κ°™μ΄ μ„¤μ •ν•΄μ•Ό ν•λ‹¤.
					
					ν”„λ΅μ‹μ €μ IN mode λ΅ λμ–΄μ§„ νλΌλ―Έν„°μ— κ°’μ„ λ„£μ–΄μ¤„λ•λ” 
					cstmt.setXXX() λ©”μ†λ“λ¥Ό μ‚¬μ©ν•λ‹¤. 
					
					ν”„λ΅μ‹μ €μ OUT mode λ΅ λμ–΄μ§„ νλΌλ―Έν„°μ— μ €μ¥λμ–΄μ§„ κ°’μ„ μλ°”μ—μ„ κΊΌλ‚΄ μ¤λ ¤λ©΄ 
					cstmt.registerOutParameter() λ©”μ†λ“λ¥Ό μ‚¬μ©ν•λ‹¤.
					
					β€» registerOutParameter() λ©”μ†λ“λ”?
					==> public void registerOutParameter(int parameterIndex, int sqlType) throws SQLException 
					    : ν”„λ΅μ‹μ €λ¥Ό μ‹¤ν–‰ν•μ—¬ λ°›μ•„μ¨ κ°’μ„ JDBCνƒ€μ…(μλ°”μ—μ„ μΈμ‹ν•λ” νƒ€μ…)μΌλ΅ λ“±λ΅μ‹μΌμ£Όλ” λ©”μ†λ“μ΄λ‹¤.
					 
					 μλ°”μ—μ„λ” μ¤λΌν΄μ OUT mode λ³€μμ— μ¤λΌν΄ λ°μ΄ν„°νƒ€μ…μΌλ΅ μ €μ¥λμ–΄ μλ” κ°’λ“¤μ„ μ½μ–΄μ™€μ„
					 JDBCνƒ€μ…(μλ°”μ—μ„ μΈμ‹ν•λ” νƒ€μ…)μΌλ΅ λ³€κ²½ν•λ” κ³Όμ •μ„ κ±°μ³μ•Όλ§ ν•λ‹¤.
					 λ€ν‘μ μΈ sqlTypeμ„ μ•μ•„λ³΄λ©΄ NULL, FLOAT, INTEGER, VARCHAR, DATE, CLOB, BLOB λ“±μ΄ μλ‹¤.
						 
				 */
				
				Scanner sc = new Scanner(System.in);
				System.out.print("π ν•™λ² : ");
				String stno = sc.nextLine();
				
				cstmt.setInt(1, Integer.parseInt(stno)); // μ«μ 1 μ€ ν”„λ΅μ‹μ € νλΌλ―Έν„°μ¤‘ μ²«λ²μ§Έ νλΌλ―Έν„°μΈ IN λ¨λ“μ ? λ¥Ό λ§ν•λ‹¤.   
				cstmt.registerOutParameter(2, java.sql.Types.INTEGER);// μ«μ 2λ” ν”„λ΅μ‹μ € νλΌλ―Έν„°μ¤‘  λ‘λ²μ§Έ νλΌλ―Έν„°μΈ OUT λ¨λ“μ ? λ¥Ό λ§ν•λ‹¤.
				cstmt.registerOutParameter(3, java.sql.Types.VARCHAR);// nvarchar2 λ„ varcharλ΅ ν•λ‹¤
				cstmt.registerOutParameter(4, java.sql.Types.VARCHAR);
				cstmt.registerOutParameter(5, java.sql.Types.VARCHAR);
				cstmt.registerOutParameter(6, java.sql.Types.INTEGER);
				cstmt.registerOutParameter(7, java.sql.Types.VARCHAR);
				cstmt.registerOutParameter(8, java.sql.Types.VARCHAR);
				cstmt.registerOutParameter(9, java.sql.Types.VARCHAR);
				
				
				// >>> 4. CallableStatement cstmt κ°μ²΄λ¥Ό μ‚¬μ©ν•μ—¬ μ¤λΌν΄μ ν”„λ΅μ‹μ € μ‹¤ν–‰ν•κΈ°  <<<
				cstmt.execute();		//μ¤λΌν΄ μ„λ²„μ—κ² ν•΄λ‹Ή ν”„λ΅μ‹μ €λ¥Ό μ‹¤ν–‰ν•΄λΌλ” κ²ƒμ΄λ‹¤.
				//λλ”
				//cstmt.executeUpdate();	//μ¤λΌν΄ μ„λ²„μ—κ² ν•΄λ‹Ή ν”„λ΅μ‹μ €λ¥Ό μ‹¤ν–‰ν•΄λΌλ” κ²ƒμ΄λ‹¤.
				
				if(cstmt.getInt(2) == 0) {
					
				}
				
				
				sc.close();
				
				
			} catch (ClassNotFoundException e) {
				System.out.println(">>> ojdbc8.jar νμΌμ΄ μ—†μµλ‹λ‹¤. <<<");
			} catch (SQLException e) {
				e.printStackTrace();
			}
		
		System.out.println("(((o(*οΎβ–½οΎ*)o)))ν”„λ΅κ·Έλ¨ μΆ…λ£");
	}//-----------------------------------end of main

}
