package jdbc.day02;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Scanner;

/*		== HRì—ì„œ ì˜ˆì „ì— ìƒì„±í•´ë‘ì—ˆë˜ pcd_tbl_member_test1_insert í”„ë¡œì‹œì € ì„ ì‚¬ìš©í•´ë³¸ë‹¤.
 create or replace procedure  pcd_tbl_member_test1_insert(p_id varchar2, p_pwd varchar2, p_name varchar2)
    is
        error_input     exception;
        error_dayTime   exception;
        number_cnt      number(2) := 0;
        char_cnt        number(2) := 0;
        special_cnt     number(2) := 0;
    begin
    
        --ì…ë ¥(insert)ì´ ë¶ˆê°€í•œ ìš”ì¼ëª…ê³¼ ì‹œê°„ëŒ€ë¥¼ ì•Œì•„ë´…ì‹œë‹¤. --
        if(to_char(sysdate, 'd') in ('1', '7') or
            to_number(to_char(sysdate, 'hh24')) <14 or
            to_number(to_char(sysdate, 'hh24')) >16 )then
            raise error_dayTime;
        
        -- ì…ë ¥(insert)ì´ ê°€ëŠ¥í•œ ìš”ì¼ëª…ê³¼ ì‹œê°„ëŒ€ ì´ë¼ë©´ ì•”í˜¸ë¥¼ ê²€ì‚¬í•˜ê² ë‹¤.
        else
            if
                length(p_pwd) > 20 or length(p_pwd)< 5 then
                raise error_input;
            end if;
            
            for i in 1..length(p_pwd) loop
                if ascii(substr(p_pwd, i, 1)) > 127 then raise error_input;
                elsif substr(p_pwd, i, 1) between 'A' and 'Z' then char_cnt := char_cnt + 1;
                elsif substr(p_pwd, i, 1) between 'a' and 'z' then char_cnt := char_cnt + 1;
                elsif substr(p_pwd, i, 1) between '0' and '9' then number_cnt := number_cnt + 1;
                else special_cnt := special_cnt + 1;
                end if;
            end loop;
            
            if
                (number_cnt = 0) or (char_cnt = 0) or (special_cnt = 0) then
                raise error_input;
            else 
                insert into tbl_member_test1(userid, passwd, name) values (p_id, p_pwd, p_name);
            end if;
        end if;
         
    exception
        when error_dayTime then
        raise_application_error(-20003, '>> ì˜ì—…ì‹œê°„(ì›”~ê¸ˆ 14:00 ~ 16:59:59 ê¹Œì§€)ì´ ì•„ë‹ˆë¯€ë¡œ ì…ë ¥ë¶ˆê°€í•¨!! <<');
        when error_input then
        raise_application_error(-20002, 'ì•”í˜¸ëŠ” ìµœì†Œ 5ê¸€ì ì´ìƒ 20ê¸€ì ì´í•˜ì˜ ì˜ë¬¸ì ë° ìˆ«ì ë° íŠ¹ìˆ˜ê¸°í˜¸ê°€ í˜¼í•©ë˜ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤');
    end pcd_tbl_member_test1_insert; 
 
 */


public class Procedure_insert_sqlexception_CallableStatement_04 {

	public static void main(String[] args) {
		
		Connection conn = null;

		CallableStatement cstmt = null;
		// CallableStatement cstmt ì€ Connection conn(ì—°ê²°í•œ DB ì„œë²„)ì— ì¡´ì¬í•˜ëŠ” Procedure ë¥¼ í˜¸ì¶œí•´ì£¼ëŠ” ê°ì²´(ìš°í¸ë°°ë‹¬ë¶€)ì´ë‹¤.
		
		try {
			Class.forName("oracle.jdbc.driver.OracleDriver");
			

			conn = DriverManager.getConnection("jdbc:oracle:thin:@127.0.0.1:1521:xe", "JDBC_USER", "gclass");
			
			
			// >>> 3. Connection conn ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ prepareCall() ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•¨ìœ¼ë¡œì¨
	        //        CallableStatement cstmt ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
	        //        ì¦‰, ìš°í¸ë°°ë‹¬ë¶€(íƒë°°ê¸°ì‚¬) ê°ì²´ ë§Œë“¤ê¸°
			cstmt = conn.prepareCall("{call pcd_tbl_member_test1_insert(?, ?, ?)}");
			/*
				 ì˜¤ë¼í´ ì„œë²„ì— ìƒì„±í•œ í”„ë¡œì‹œì € pcd_student_select_one ì˜ 
            	 ë§¤ê°œë³€ìˆ˜ ê°¯ìˆ˜ê°€ 2ê°œ ì´ë¯€ë¡œ ? ë¥¼ 2ê°œ ì¤€ë‹¤.
            	 
            	 ë‹¤ìŒìœ¼ë¡œ ì˜¤ë¼í´ì˜ í”„ë¡œì‹œì €ë¥¼ ìˆ˜í–‰( executeUpdate() ë˜ëŠ” execute() ) í•˜ê¸°ì— ì•ì„œì„œ  
				ë°˜ë“œì‹œ í•´ì•¼í•  ì¼ì€ IN mode ë¡œ ë˜ì–´ì§„ íŒŒë¼ë¯¸í„°ì— ê°’ì„ ë„£ì–´ì£¼ê³ ,
				OUT mode ë¡œ ì„¤ì •ëœ ê³³ì— ê·¸ ê²°ê³¼ê°’ì„ ë°›ì•„ì˜¤ë„ë¡ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•´ì•¼ í•œë‹¤.
				
				í”„ë¡œì‹œì €ì˜ IN mode ë¡œ ë˜ì–´ì§„ íŒŒë¼ë¯¸í„°ì— ê°’ì„ ë„£ì–´ì¤„ë•ŒëŠ” 
				cstmt.setXXX() ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•œë‹¤. 
					 
			 */
			
			Scanner sc = new Scanner(System.in);
			System.out.print("ğŸ˜ ì•„ì´ë”” : ");
			String userid = sc.nextLine();	//ì„œìš¸ ê°•ë‚¨êµ¬
			
			System.out.print("ğŸ˜ ë¹„ë°€ë²ˆí˜¸ : ");
			String passwd = sc.nextLine();	//ì„œìš¸ ê°•ë‚¨êµ¬
			
			System.out.print("ğŸ˜ ì„±ëª… : ");
			String name = sc.nextLine();	//ì„œìš¸ ê°•ë‚¨êµ¬
			
			cstmt.setString(1, userid); // ìˆ«ì 1 ì€ í”„ë¡œì‹œì € íŒŒë¼ë¯¸í„°ì¤‘ ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì¸ IN ëª¨ë“œì˜ ? ë¥¼ ë§í•œë‹¤.
			cstmt.setString(2, passwd); // ìˆ«ì 1 ì€ í”„ë¡œì‹œì € íŒŒë¼ë¯¸í„°ì¤‘ ë‘ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì¸ IN ëª¨ë“œì˜ ? ë¥¼ ë§í•œë‹¤.
			cstmt.setString(3, name); 	// ìˆ«ì 1 ì€ í”„ë¡œì‹œì € íŒŒë¼ë¯¸í„°ì¤‘ ì„¸ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì¸ IN ëª¨ë“œì˜ ? ë¥¼ ë§í•œë‹¤.
			
			// >>> 4. CallableStatement cstmt ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¤ë¼í´ì˜ í”„ë¡œì‹œì € ì‹¤í–‰í•˜ê¸°  <<<
			//cstmt.execute();		//ì˜¤ë¼í´ ì„œë²„ì—ê²Œ í•´ë‹¹ í”„ë¡œì‹œì €ë¥¼ ì‹¤í–‰í•´ë¼ëŠ” ê²ƒì´ë‹¤.
			//ë˜ëŠ”
			int n = cstmt.executeUpdate();	//ì˜¤ë¼í´ ì„œë²„ì—ê²Œ í•´ë‹¹ í”„ë¡œì‹œì €ë¥¼ ì‹¤í–‰í•´ë¼ëŠ” ê²ƒì´ë‹¤.
			
			rs = (ResultSet) cstmt.getObject(2);
			// ì—¬ê¸°ì„œ ìˆ«ì 2ëŠ” í”„ë¡œì‹œì €ì˜ íŒŒë¼ë¯¸í„° ìˆœì„œë¥¼ ë§í•œë‹¤.
			// ì¦‰, 2ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì— ì €ì¥ë˜ì–´ì§„ ì •ë³´ë¥¼ êº¼ë‚´ì˜¤ëŠ”ë° ë¦¬í„´íƒ€ì…ì´ Object ì´ë‹¤.
			// ì—¬ê¸°ì„œ 2ë²ˆì§¸ íŒŒë¼ë¯¸í„°ëŠ” CURSORë¡œ ë˜ì–´ì§„ OUT ëª¨ë“œì´ë©° select ë˜ì–´ì§„ ê²°ê³¼ë¬¼ì´ë‹¤.
			// ê·¸ëŸ¬ë¯€ë¡œ Object íƒ€ì…ìœ¼ë¡œ ë¦¬í„´ëœ ê²ƒì„ ResultSet íƒ€ì…ìœ¼ë¡œ casting(ê°•ì œí˜•ë³€í™˜)ì‹œì¼œì•¼ í•œë‹¤.
			
			StringBuilder sb = new StringBuilder();
			
			
			int cnt = 0;
			
			while (rs.next()) {
				cnt ++;
				if(cnt == 1) {
					sb.append("-".repeat(80) + "\n");
					sb.append("í•™ë²ˆ\tì„±ëª…\tì—°ë½ì²˜\t\tì£¼ì†Œ\t\tì…ë ¥ì¼ì\t\tí•™ê¸‰ë²ˆí˜¸\tí•™ê¸‰ëª…\t\të‹´ì„ëª…\n");
					sb.append("-".repeat(80) + "\n");	
				}
				//stno, name, tel, addr, to_char(registerdate, 'yyyy-mm-dd') as registerday, fk_classno, classname, teachername

				sb.append(rs.getInt("stno") + "\t");
				sb.append(rs.getString("name")+ "\t");
				sb.append(rs.getString("tel")+ "\t");
				sb.append(rs.getString("addr")+ "\t");
				sb.append(rs.getString("registerday")+ "\t");
				sb.append(rs.getInt("fk_classno")+ "\t");
				sb.append(rs.getString("classname")+ "\t");
				sb.append(rs.getString("teachername")+ "\n");
			}// end of while------------------------------------------
			
			if(cnt == 0) {
				System.out.println(">>>ê²€ìƒ‰í•˜ì‹  ì£¼ì†Œì— " + searchAddr + "ëŠ” ì—†ìŠµë‹ˆë‹¤!!!<<<");
			}
			else {
				System.out.println(sb.toString());
			}
			
			
			
			sc.close();

		} catch (ClassNotFoundException e) {
			System.out.println(">>> ojdbc8.jar íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. <<<");
		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			try {
				if(rs != null) {
					rs.close();
					rs = null;
				}

				if (cstmt != null) {
					cstmt.close();
					cstmt = null;
				}

				if (conn != null) {
					conn.close();
					conn = null;
				}

			} catch (SQLException e) {
				e.printStackTrace();
			}
		}

		System.out.println("(((o(*ï¾Ÿâ–½ï¾Ÿ*)o)))í”„ë¡œê·¸ë¨ ì¢…ë£Œ");


	}

}
