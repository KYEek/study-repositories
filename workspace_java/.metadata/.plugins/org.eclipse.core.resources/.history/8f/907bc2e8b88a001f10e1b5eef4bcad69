package jdbc.day02;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Scanner;

/*
 
 create or replace procedure pcd_student_select_many
    (p_addr in varchar2
    ,o_data out sys_refcursor )
    is
       
    BEGIN
        open o_data for
        select stno, name, tel, addr, to_char(registerdate, 'yyyy-mm-dd') as registerday, fk_classno, classname, teachername
        from (select *
              from tbl_student
              where addr like '%'|| 'μ„μΈ' ||'%') S join tbl_class C
        on s.fk_classno = c.classno;
    end pcd_student_select_many;
     
 
 */


public class Procedure_select_many_CallableStatement_03 {

	public static void main(String[] args) {

		Connection conn = null;

		CallableStatement cstmt = null;
		// CallableStatement cstmt μ€ Connection conn(μ—°κ²°ν• DB μ„λ²„)μ— μ΅΄μ¬ν•λ” Procedure λ¥Ό νΈμ¶ν•΄μ£Όλ” κ°μ²΄(μ°νΈλ°°λ‹¬λ¶€)μ΄λ‹¤.
		
		ResultSet rs = null;

		try {
			Class.forName("oracle.jdbc.driver.OracleDriver");
			

			conn = DriverManager.getConnection("jdbc:oracle:thin:@127.0.0.1:1521:xe", "JDBC_USER", "gclass");
			
			
			// >>> 3. Connection conn κ°μ²΄λ¥Ό μ‚¬μ©ν•μ—¬ prepareCall() λ©”μ†λ“λ¥Ό νΈμ¶ν•¨μΌλ΅μ¨
	        //        CallableStatement cstmt κ°μ²΄λ¥Ό μƒμ„±ν•λ‹¤.
	        //        μ¦‰, μ°νΈλ°°λ‹¬λ¶€(νƒλ°°κΈ°μ‚¬) κ°μ²΄ λ§λ“¤κΈ°
			cstmt = conn.prepareCall("{call pcd_student_select_many(?, ?)}");
			/*
				 μ¤λΌν΄ μ„λ²„μ— μƒμ„±ν• ν”„λ΅μ‹μ € pcd_student_select_one μ 
            	 λ§¤κ°λ³€μ κ°―μκ°€ 2κ° μ΄λ―€λ΅ ? λ¥Ό 2κ° μ¤€λ‹¤.
            	 
            	 λ‹¤μμΌλ΅ μ¤λΌν΄μ ν”„λ΅μ‹μ €λ¥Ό μν–‰( executeUpdate() λλ” execute() ) ν•κΈ°μ— μ•μ„μ„  
				λ°λ“μ‹ ν•΄μ•Όν•  μΌμ€ IN mode λ΅ λμ–΄μ§„ νλΌλ―Έν„°μ— κ°’μ„ λ„£μ–΄μ£Όκ³ ,
				OUT mode λ΅ μ„¤μ •λ κ³³μ— κ·Έ κ²°κ³Όκ°’μ„ λ°›μ•„μ¤λ„λ΅ μ•„λμ™€ κ°™μ΄ μ„¤μ •ν•΄μ•Ό ν•λ‹¤.
				
				ν”„λ΅μ‹μ €μ IN mode λ΅ λμ–΄μ§„ νλΌλ―Έν„°μ— κ°’μ„ λ„£μ–΄μ¤„λ•λ” 
				cstmt.setXXX() λ©”μ†λ“λ¥Ό μ‚¬μ©ν•λ‹¤. 
				
				ν”„λ΅μ‹μ €μ OUT mode λ΅ λμ–΄μ§„ νλΌλ―Έν„°μ— μ €μ¥λμ–΄μ§„ κ°’μ„ μλ°”μ—μ„ κΊΌλ‚΄ μ¤λ ¤λ©΄ 
				cstmt.registerOutParameter() λ©”μ†λ“λ¥Ό μ‚¬μ©ν•λ‹¤.
				
				β€» registerOutParameter() λ©”μ†λ“λ”?
				==> public void registerOutParameter(int parameterIndex, int sqlType) throws SQLException 
				    : ν”„λ΅μ‹μ €λ¥Ό μ‹¤ν–‰ν•μ—¬ λ°›μ•„μ¨ κ°’μ„ JDBCνƒ€μ…(μλ°”μ—μ„ μΈμ‹ν•λ” νƒ€μ…)μΌλ΅ λ“±λ΅μ‹μΌμ£Όλ” λ©”μ†λ“μ΄λ‹¤.
				 
				 μλ°”μ—μ„λ” μ¤λΌν΄μ OUT mode λ³€μμ— μ¤λΌν΄ λ°μ΄ν„°νƒ€μ…μΌλ΅ μ €μ¥λμ–΄ μλ” κ°’λ“¤μ„ μ½μ–΄μ™€μ„
				 JDBCνƒ€μ…(μλ°”μ—μ„ μΈμ‹ν•λ” νƒ€μ…)μΌλ΅ λ³€κ²½ν•λ” κ³Όμ •μ„ κ±°μ³μ•Όλ§ ν•λ‹¤.
				 λ€ν‘μ μΈ sqlTypeμ„ μ•μ•„λ³΄λ©΄ NULL, FLOAT, INTEGER, VARCHAR, DATE, CLOB, BLOB λ“±μ΄ μλ‹¤.
					 
			 */
			
			Scanner sc = new Scanner(System.in);
			System.out.print("π μ£Όμ† : ");
			String searchAddr = sc.nextLine();	//μ„μΈ κ°•λ‚¨κµ¬
			
			cstmt.setString(1, searchAddr); // μ«μ 1 μ€ ν”„λ΅μ‹μ € νλΌλ―Έν„°μ¤‘ μ²«λ²μ§Έ νλΌλ―Έν„°μΈ IN λ¨λ“μ ? λ¥Ό λ§ν•λ‹¤.   
			cstmt.registerOutParameter(2, oracle.jdbc.OracleTypes.CURSOR);// μ«μ 2λ” ν”„λ΅μ‹μ € νλΌλ―Έν„°μ¤‘  λ‘λ²μ§Έ νλΌλ―Έν„°μΈ OUT λ¨λ“μ ? λ¥Ό λ§ν•λ‹¤.
			
			// >>> 4. CallableStatement cstmt κ°μ²΄λ¥Ό μ‚¬μ©ν•μ—¬ μ¤λΌν΄μ ν”„λ΅μ‹μ € μ‹¤ν–‰ν•κΈ°  <<<
			cstmt.execute();		//μ¤λΌν΄ μ„λ²„μ—κ² ν•΄λ‹Ή ν”„λ΅μ‹μ €λ¥Ό μ‹¤ν–‰ν•΄λΌλ” κ²ƒμ΄λ‹¤.
			//λλ”
			//cstmt.executeUpdate();	//μ¤λΌν΄ μ„λ²„μ—κ² ν•΄λ‹Ή ν”„λ΅μ‹μ €λ¥Ό μ‹¤ν–‰ν•΄λΌλ” κ²ƒμ΄λ‹¤.
			
			rs = (ResultSet) cstmt.getObject(2);
			// μ—¬κΈ°μ„ μ«μ 2λ” ν”„λ΅μ‹μ €μ νλΌλ―Έν„° μμ„λ¥Ό λ§ν•λ‹¤.
			// μ¦‰, 2λ²μ§Έ νλΌλ―Έν„°μ— μ €μ¥λμ–΄μ§„ μ •λ³΄λ¥Ό κΊΌλ‚΄μ¤λ”λ° λ¦¬ν„΄νƒ€μ…μ΄ Object μ΄λ‹¤.
			// μ—¬κΈ°μ„ 2λ²μ§Έ νλΌλ―Έν„°λ” CURSORλ΅ λμ–΄μ§„ OUT λ¨λ“μ΄λ©° select λμ–΄μ§„ κ²°κ³Όλ¬Όμ΄λ‹¤.
			// κ·Έλ¬λ―€λ΅ Object νƒ€μ…μΌλ΅ λ¦¬ν„΄λ κ²ƒμ„ ResultSet νƒ€μ…μΌλ΅ casting(κ°•μ ν•λ³€ν™)μ‹μΌμ•Ό ν•λ‹¤.
			
			StringBuilder sb = new StringBuilder();
			
			
			int cnt = 0;
			
			while (rs.next()) {
				cnt ++;
				if(cnt == 1) {
					sb.append("-".repeat(80) + "\t");
					sb.append("ν•™λ²\tμ„±λ…\tμ—°λ½μ²\t\tμ£Όμ†\t\tμ…λ ¥μΌμ\t\tν•™κΈ‰λ²νΈ\tν•™κΈ‰λ…\t\tλ‹΄μ„λ…\n");
					sb.append("-".repeat(80) + "\t");	
				}
				//stno, name, tel, addr, to_char(registerdate, 'yyyy-mm-dd') as registerday, fk_classno, classname, teachername

				sb.append(rs.getInt("stno") + "\t");
				sb.append(rs.getString("name")+ "\t");
				sb.append(rs.getString("tel")+ "\t");
				sb.append(rs.getString("addr")+ "\t");
				sb.append(rs.getString("registerday")+ "\t");
				sb.append(rs.getInt("fk_classno")+ "\t");
				sb.append(rs.getString("classname")+ "\t");
				sb.append(rs.getString("teachername")+ "\t");
			}// end of while------------------------------------------
			
			
			
			
			sc.close();

		} catch (ClassNotFoundException e) {
			System.out.println(">>> ojdbc8.jar νμΌμ΄ μ—†μµλ‹λ‹¤. <<<");
		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			try {

				if (cstmt != null) {
					cstmt.close();
					cstmt = null;
				}

				if (conn != null) {
					conn.close();
					conn = null;
				}

			} catch (SQLException e) {
				e.printStackTrace();
			}
		}

		System.out.println("(((o(*οΎβ–½οΎ*)o)))ν”„λ΅κ·Έλ¨ μΆ…λ£");

		

	}// end of main()----------------------------------------

}
